# MinIO Cloud Storage Service

## Описание проекта
Данный проект представляет собой облачное хранилище на основе MinIO, реализованное с использованием Spring Boot. Сервис поддерживает загрузку, скачивание, перемещение, удаление файлов и папок, а также управление доступом пользователей через JWT-аутентификацию. Данные о файлах хранятся в MongoDB.

## Основные технологии
- **Spring Boot** – основной фреймворк приложения
- **MinIO** – объектное хранилище для файлов
- **MongoDB** – база данных для хранения информации о файлах и папках
- **Spring Security & JWT** – аутентификация и авторизация
- **Docker & Docker Compose** – контейнеризация приложения

## Основные компоненты

### 1. **StorageService**
Отвечает за операции с файлами и папками:
- Загрузка файлов
- Перемещение файлов и папок
- Удаление файлов и папок
- Создание начальной папки пользователя
- Получение информации о файле или папке

### 2. **MinioFileService**
Компонент, работающий с файлами в MinIO. Поддерживает:
- Загрузку файлов
- Удаление файлов
- Проверку наличия файлов
- Копирование файлов

### 3. **MinioFolderService**
Компонент для работы с папками в MinIO:
- Создание пустой папки
- Удаление папки и всех вложенных файлов
- Копирование папки
- Архивирование и скачивание папки

### 4. **MinioServiceResolver**
Фабрика, определяющая, какой сервис использовать (файловый или папочный) на основе пути.

### 5. **MongoDB (MinioResourceRepository)**
Репозиторий для хранения информации о файлах и папках в MongoDB.

## API Эндпоинты
### **Управление файлами и папками**
| Метод | URL | Описание |
|--------|-----------------|--------------------------|
| POST | `/api/storage/upload` | Загрузка файлов |
| GET | `/api/storage/download/{path}` | Скачивание файла или папки |
| POST | `/api/storage/move` | Перемещение файлов и папок |
| DELETE | `/api/storage/delete/{path}` | Удаление файла или папки |
| POST | `/api/storage/folder/create` | Создание папки |
| GET | `/api/storage/folder/contents/{path}` | Получение содержимого папки |

### **Аутентификация**
| Метод | URL | Описание |
|--------|-----------------|--------------------------|
| POST | `/api/auth/register` | Регистрация пользователя |
| POST | `/api/auth/login` | Вход пользователя |
| GET | `/api/user/info` | Получение информации о пользователе |

## Конфигурация MinIO
В файле `application.properties` указываются настройки MinIO:
```properties
minio.endpoint=http://localhost:9000
minio.access-key=your-access-key
minio.secret-key=your-secret-key
minio.bucket-name=your-bucket-name
minio.max_mb_capacity_for_user=500
```

## Развертывание проекта

### Локальная среда (development)

Для локального запуска используется `compose.yml`, который включает следующие сервисы:

- `postgres` (PostgreSQL 15.3)
- `minio` (MinIO с консольным доступом)
- `mongo` (MongoDB 7.0.16)

Запуск:
```sh
docker-compose up -d
```

### Продакшен (production)

Для продакшена используется `compose-prod.yml`, который:
- Изолирует сервисы в `shared-network`
- Загружает переменные среды из `.env`
- Использует `init-mongo.js` для инициализации базы MongoDB
- Включает `cloud-frontend` и `cloud6x` (основное серверное приложение)

Запуск:
```sh
docker-compose -f compose-prod.yml up -d
```

### Переменные среды
Создайте `.env` файл с настройками:
```ini
POSTGRES_DB=cloudstorage
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
MONGO_INITDB_ROOT_USERNAME=admin
MONGO_INITDB_ROOT_PASSWORD=admin
MINIO_ROOT_USER=user
MINIO_ROOT_PASSWORD=12345678
MINIO_BUCKET_NAME=my-bucket
JWT_SECRET=supersecretkey
ACCESS_TOKEN_EXPIRATION=60
REFRESH_TOKEN_EXPIRATION=7
SPRING_PROFILES_ACTIVE=prod
```

---

## Конфигурация Spring Boot (application-prod.yml)

Основные настройки:
- Подключение к **MongoDB** и **PostgreSQL** через переменные среды
- Интеграция с **MinIO** для работы с файлами
- Использование **Liquibase** для миграций БД
- Ограничение размера загружаемых файлов (100MB)


---

## MongoDB + MinIO

Выбор сочетания **MongoDB** и **MinIO** для данного проекта:
- **MinIO** отлично справляется с хранением файлов, обеспечивая API совместимый с AWS S3.
- **MongoDB** подходит для хранения метаданных файлов, предоставляя гибкость в работе со структурированными и неструктурированными данными.
- Такой подход позволяет легко масштабировать систему, распределяя нагрузку между базами данных и объектным хранилищем.

Добавление скрипта init-mongo.js и его выполнение при старте контейнера MongoDB является необходимым шагом, 
потому что при контейнеризации MongoDB, 
вам нужно позаботиться о настройке начальных данных, таких как создание базы данных, пользователей и прав доступа. 
В противном случае база данных будет пустой и не настроенной, что приведет к проблемам при попытке подключиться и работать с ней. 
Вот почему этот шаг критически важен при контейнеризации MongoDB.

В MongoDB по умолчанию не существует пользователей, и подключение без их создания возможно только в том случае, 
если безопасность базы данных отключена (что нежелательно). При включении аутентификации MongoDB требует, 
чтобы пользователи были созданы заранее, 
и только они могут получать доступ к базе данных.
Без скрипта: Если бы вы не использовали скрипт для автоматического создания пользователя и прав доступа, 
вам пришлось бы вручную подключаться к контейнеру MongoDB, 
запускать команды для создания пользователя и настраивать права доступа. 
Это не только неудобно, но и создает риски, так как это нужно делать каждый раз при развертывании контейнера.


